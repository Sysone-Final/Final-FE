name: Deploy to VM Instance

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint
      
    - name: Build project
      run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/final-fe:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Deploy to GCP VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          cd ~
          
          # ì„œë²„ ì´ˆê¸° ì„¤ì • í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v docker &> /dev/null || ! command -v docker-compose &> /dev/null; then
            echo "ðŸš€ ì„œë²„ ì´ˆê¸° ì„¤ì •ì„ ì‹œìž‘í•©ë‹ˆë‹¤..."
            
            # ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
            sudo apt update && sudo apt upgrade -y
            
            # Docker ì„¤ì¹˜
            echo "Docker ì„¤ì¹˜ ì¤‘..."
            sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt update
            sudo apt install -y docker-ce docker-ce-cli containerd.io
            
            # Docker ì„œë¹„ìŠ¤ ì‹œìž‘
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG docker $USER
            
            # Docker Compose ì„¤ì¹˜
            echo "Docker Compose ì„¤ì¹˜ ì¤‘..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            
            # ë°©í™”ë²½ ì„¤ì •
            echo "ë°©í™”ë²½ ì„¤ì • ì¤‘..."
            sudo ufw allow OpenSSH
            sudo ufw allow 80/tcp  
            sudo ufw allow 443/tcp
            sudo ufw --force enable
            
            # ìœ í‹¸ë¦¬í‹° ì„¤ì¹˜
            sudo apt install -y htop curl wget git vim net-tools
            
            echo "âœ… ì„œë²„ ì´ˆê¸° ì„¤ì • ì™„ë£Œ!"
          else
            echo "âœ… Dockerì™€ Docker Composeê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìžˆìŠµë‹ˆë‹¤."
          fi
          
          # Docker Compose íŒŒì¼ ìƒì„±
          cat > docker-compose.yml << EOF
          version: '3.8'
          
          services:
            web:
              image: ${{ secrets.DOCKER_USERNAME }}/final-fe:latest
              ports:
                - "80:80"
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
          EOF
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          sudo docker-compose down || true
          
          # ì˜¤ëž˜ëœ ì´ë¯¸ì§€ ì œê±°
          sudo docker rmi ${{ secrets.DOCKER_USERNAME }}/final-fe:latest || true
          
          # ìµœì‹  ì´ë¯¸ì§€ í’€ ë° ì‹¤í–‰
          sudo docker-compose pull
          sudo docker-compose up -d
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
          sudo docker image prune -f
          
          # ë°°í¬ ìƒíƒœ í™•ì¸
          sleep 10
          sudo docker-compose ps
          
          echo "âœ… GCP VM ë°°í¬ ì™„ë£Œ: http://serverway.shop"
